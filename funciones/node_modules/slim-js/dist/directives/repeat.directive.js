import{processDOM as P,removeBindings as I,Internals as O,DirectiveRegistry as j}from"../index.js";const{block:k,internals:a,repeatCtx:u}=O,H=(e=[],t)=>{e.forEach(n=>{I(t,n),n[a][y]()})},d=Symbol(),y=Symbol(),T=e=>e.forEach(t=>t()),U=(e,t)=>{let n=t,s="";for(;e>1;)e&1&&(s+=n),e>>=1,n+=n;return s+n},_=e=>({tpl:document.createElement("template"),ptr:0,pool:[],alloc(t){const n=t-this.pool.length,{tpl:s}=this;n>0&&(s.innerHTML=U(n,e),this.pool=this.pool.concat(Array.from(s.content.children)))},get(t){return this.ptr+t>this.pool.length&&this.alloc(this.ptr+t-this.pool.length),this.ptr+=t,this.pool.slice(this.ptr-t,this.ptr)},dump(t){return this.ptr-=t,this.ptr<0&&(this.ptr=0),this.pool.slice(this.ptr)}}),x="*repeat",B="*repeat-cleanup",b=new Range;let g=[];const F={attribute:(e,t)=>t===x,process:({targetNode:e,scopeNode:t,expression:n})=>{let s=parseInt(e.getAttribute(B))||5e3;e[k]="abort",e.removeAttribute(x),e.removeAttribute(B);const D=e.outerHTML,E=document.createComment("*repeat"),A=e.parentElement||e.parentNode||t.shadowRoot||t,i=_(D);A.insertBefore(E,e);let m;const v=document.createDocumentFragment();let o=[],R,C;function w(l=[],L=!1){m&&clearTimeout(m);const f=Math.abs(l.length-o.length);i.alloc(l.length),l.length<o.length&&(g=i.dump(f),b.setStartBefore(g[0]),b.setEndAfter(g[f-1]),b.deleteContents(),o.length=l.length);for(let r=0;r<o.length;r++){const p=o[r],c=l[r];(L||p[u]!==c)&&(p[u]=c,T(p[a][d]))}if(l.length>o.length){const r=i.get(f),p=r[Symbol.iterator]();for(let c=o.length;c<l.length;c++){const h=p.next().value,M=l[c];h[u]=M,h[a]||({bounds:R,clear:C}=P(t,h),Object.assign(h[a],{[d]:R,[y]:C})),T(h[a][d])}o=o.concat(r),v.append(...r),A.insertBefore(v,E)}m=setTimeout(()=>{H(g.concat(),t),i.pool=i.pool.slice(0,i.ptr),g.length=0},s)}return{update:w,removeNode:!0}}};j.add(F,!0);
